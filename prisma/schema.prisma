generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id             String         @id @default(uuid())
  email          String         @unique
  password       String
  name           String
  isActive       Boolean        @default(true)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  roleId         String?
  ownedGym       Gym?           @relation("GymOwner")
  memberProfile  Member?
  refreshTokens  RefreshToken[]
  trainerProfile Trainer?
  role           Rolemaster?    @relation(fields: [roleId], references: [Id])

  @@index([email])
  @@index([roleId])
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

model GymSubscriptionPlan {
  id            String   @id @default(uuid())
  name          String
  description   String?
  price         Decimal  @db.Decimal(10, 2)
  durationDays  Int
  features      String
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  priceCurrency String   @default("INR")
  gyms          Gym[]

  @@index([isActive])
  @@index([priceCurrency])
}

model Gym {
  id                 String               @id @default(uuid())
  name               String
  address            String?
  phone              String?
  email              String?
  logo               String?
  isActive           Boolean              @default(true)
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  ownerId            String?              @unique
  subscriptionPlanId String?
  subscriptionStart  DateTime?
  subscriptionEnd    DateTime?
  dietPlans          DietPlan[]
  exercisePlans      ExercisePlan[]
  owner              User?                @relation("GymOwner", fields: [ownerId], references: [id])
  subscriptionPlan   GymSubscriptionPlan? @relation(fields: [subscriptionPlanId], references: [id])
  members            Member[]
  trainers           Trainer[]

  @@index([ownerId])
}

model Trainer {
  id             String                    @id @default(uuid())
  specialization String?
  experience     Int?
  phone          String?
  isActive       Boolean                   @default(true)
  createdAt      DateTime                  @default(now())
  updatedAt      DateTime                  @updatedAt
  userId         String                    @unique
  gymId          String
  members        MemberTrainerAssignment[]
  gym            Gym                       @relation(fields: [gymId], references: [id], onDelete: Cascade)
  user           User                      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([gymId])
}

model Member {
  id                  String                     @id @default(uuid())
  phone               String?
  dateOfBirth         DateTime?
  gender              String?
  address             String?
  emergencyContact    String?
  healthNotes         String?
  createdAt           DateTime                   @default(now())
  updatedAt           DateTime                   @updatedAt
  userId              String                     @unique
  gymId               String
  membershipStart     DateTime                   @default(now())
  membershipEnd       DateTime
  membershipStatus    SubscriptionStatus         @default(ACTIVE)
  gym                 Gym                        @relation(fields: [gymId], references: [id], onDelete: Cascade)
  user                User                       @relation(fields: [userId], references: [id], onDelete: Cascade)
  dietAssignments     MemberDietAssignment[]
  exerciseAssignments MemberExerciseAssignment[]
  trainerAssignments  MemberTrainerAssignment[]

  @@index([gymId])
  @@index([membershipStatus])
}

model DietPlan {
  id          String                 @id @default(uuid())
  name        String
  description String?
  calories    Int?
  meals       Json
  isActive    Boolean                @default(true)
  createdAt   DateTime               @default(now())
  updatedAt   DateTime               @updatedAt
  gymId       String
  gym         Gym                    @relation(fields: [gymId], references: [id], onDelete: Cascade)
  assignments MemberDietAssignment[]

  @@index([gymId])
}

model ExercisePlan {
  id          String                     @id @default(uuid())
  name        String
  description String?
  type        String?
  exercises   Json
  isActive    Boolean                    @default(true)
  createdAt   DateTime                   @default(now())
  updatedAt   DateTime                   @updatedAt
  gymId       String
  gym         Gym                        @relation(fields: [gymId], references: [id], onDelete: Cascade)
  assignments MemberExerciseAssignment[]

  @@index([gymId])
}

model MemberTrainerAssignment {
  id         String   @id @default(uuid())
  memberId   String
  trainerId  String
  assignedAt DateTime @default(now())
  isActive   Boolean  @default(true)
  member     Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)
  trainer    Trainer  @relation(fields: [trainerId], references: [id], onDelete: Cascade)

  @@unique([memberId, trainerId])
  @@index([memberId])
  @@index([trainerId])
}

model MemberDietAssignment {
  id         String    @id @default(uuid())
  memberId   String
  dietPlanId String
  assignedAt DateTime  @default(now())
  startDate  DateTime  @default(now())
  endDate    DateTime?
  isActive   Boolean   @default(true)
  dietPlan   DietPlan  @relation(fields: [dietPlanId], references: [id], onDelete: Cascade)
  member     Member    @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId])
  @@index([dietPlanId])
}

model MemberExerciseAssignment {
  id             String       @id @default(uuid())
  memberId       String
  exercisePlanId String
  assignedAt     DateTime     @default(now())
  dayOfWeek      Int?
  startDate      DateTime     @default(now())
  endDate        DateTime?
  isActive       Boolean      @default(true)
  exercisePlan   ExercisePlan @relation(fields: [exercisePlanId], references: [id], onDelete: Cascade)
  member         Member       @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId])
  @@index([exercisePlanId])
}

model Rolemaster {
  Id       String @id @default(uuid()) @map("Id")
  rolename String @map("rolename")
  users    User[]

  @@map("Rolemaster")
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELLED
}
