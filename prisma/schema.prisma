generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Role enum removed in favor of Rolemaster table

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELLED
}

// Core Users table - handles all user types
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String
  name          String
  roleId        String?
  role          Rolemaster? @relation(fields: [roleId], references: [Id])
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  ownedGym      Gym?      @relation("GymOwner")
  memberProfile Member?
  trainerProfile Trainer?
  refreshTokens RefreshToken[]
  
  @@index([email])
  @@index([roleId])
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([token])
  @@index([userId])
}

// Gym Subscription Plans (created by Admin)
model GymSubscriptionPlan {
  id          String   @id @default(uuid())
  name        String   // Basic, Pro, Premium
  description String?
  price       Decimal  @db.Decimal(10, 2)
  durationDays Int     // 30, 90, 365
  features    String[] // Array of features
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  gyms        Gym[]
}

// Gyms
model Gym {
  id              String    @id @default(uuid())
  name            String
  address         String?
  phone           String?
  email           String?
  logo            String?
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Gym Owner relation
  ownerId         String?   @unique
  owner           User?     @relation("GymOwner", fields: [ownerId], references: [id])
  
  // Subscription Plan
  subscriptionPlanId String?
  subscriptionPlan   GymSubscriptionPlan? @relation(fields: [subscriptionPlanId], references: [id])
  subscriptionStart  DateTime?
  subscriptionEnd    DateTime?
  
  // Related entities
  members         Member[]
  trainers        Trainer[]
  dietPlans       DietPlan[]
  exercisePlans   ExercisePlan[]
  
  @@index([ownerId])
}

// Trainers (created by Gym Owner)
model Trainer {
  id          String   @id @default(uuid())
  specialization String?
  experience  Int?     // Years of experience
  phone       String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // User relation (trainer has login)
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Gym relation
  gymId       String
  gym         Gym      @relation(fields: [gymId], references: [id], onDelete: Cascade)
  
  // Assigned members
  members     MemberTrainerAssignment[]
  
  @@index([gymId])
}

// Members (created by Gym Owner)
model Member {
  id                  String   @id @default(uuid())
  phone               String?
  dateOfBirth         DateTime?
  gender              String?
  address             String?
  emergencyContact    String?
  healthNotes         String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  // User relation (member has login)
  userId              String   @unique
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Gym relation
  gymId               String
  gym                 Gym      @relation(fields: [gymId], references: [id], onDelete: Cascade)
  
  // Membership details
  membershipStart     DateTime @default(now())
  membershipEnd       DateTime
  membershipStatus    SubscriptionStatus @default(ACTIVE)
  
  // Assignments
  trainerAssignments  MemberTrainerAssignment[]
  dietAssignments     MemberDietAssignment[]
  exerciseAssignments MemberExerciseAssignment[]
  
  @@index([gymId])
  @@index([membershipStatus])
}

// Diet Plans (created by Gym Owner)
model DietPlan {
  id          String   @id @default(uuid())
  name        String
  description String?
  calories    Int?
  meals       Json     // Structured meal data
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  gymId       String
  gym         Gym      @relation(fields: [gymId], references: [id], onDelete: Cascade)
  
  assignments MemberDietAssignment[]
  
  @@index([gymId])
}

// Exercise Plans (created by Gym Owner)
model ExercisePlan {
  id          String   @id @default(uuid())
  name        String
  description String?
  type        String?  // Daily, Weekly
  exercises   Json     // Structured exercise data
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  gymId       String
  gym         Gym      @relation(fields: [gymId], references: [id], onDelete: Cascade)
  
  assignments MemberExerciseAssignment[]
  
  @@index([gymId])
}

// Member-Trainer Assignment
model MemberTrainerAssignment {
  id          String   @id @default(uuid())
  memberId    String
  trainerId   String
  assignedAt  DateTime @default(now())
  isActive    Boolean  @default(true)
  
  member      Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)
  trainer     Trainer  @relation(fields: [trainerId], references: [id], onDelete: Cascade)
  
  @@unique([memberId, trainerId])
  @@index([memberId])
  @@index([trainerId])
}

// Member-Diet Assignment
model MemberDietAssignment {
  id          String   @id @default(uuid())
  memberId    String
  dietPlanId  String
  assignedAt  DateTime @default(now())
  startDate   DateTime @default(now())
  endDate     DateTime?
  isActive    Boolean  @default(true)
  
  member      Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)
  dietPlan    DietPlan @relation(fields: [dietPlanId], references: [id], onDelete: Cascade)
  
  @@index([memberId])
  @@index([dietPlanId])
}

// Member-Exercise Assignment
model MemberExerciseAssignment {
  id            String   @id @default(uuid())
  memberId      String
  exercisePlanId String
  assignedAt    DateTime @default(now())
  dayOfWeek     Int?     // 0-6 for weekly plans
  startDate     DateTime @default(now())
  endDate       DateTime?
  isActive      Boolean  @default(true)
  
  member        Member       @relation(fields: [memberId], references: [id], onDelete: Cascade)
  exercisePlan  ExercisePlan @relation(fields: [exercisePlanId], references: [id], onDelete: Cascade)
  
  @@index([memberId])
  @@index([exercisePlanId])
}

// Rolemaster table for roles
model Rolemaster {
  Id       String @id @default(uuid()) @map("Id")
  rolename String          @map("rolename")
  users    User[]

  @@map("Rolemaster")
}
